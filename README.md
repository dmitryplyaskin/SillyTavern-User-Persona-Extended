# Persona Extensions - Расширение для SillyTavern

Расширение для SillyTavern, которое позволяет добавлять дополнительные описания для каждой персоны и автоматически включать их в промпт при генерации ответов.

## Назначение

Расширение `persona-extensions` предоставляет возможность создавать несколько блоков дополнительных описаний для каждой персоны. Каждый блок может иметь:
- **Заголовок** - краткое название блока
- **Описание** - основной текст описания
- **Статус включения** - возможность временно отключить блок без его удаления

Все включенные блоки автоматически добавляются в системный промпт при генерации ответов.

## Как работает расширение

### Архитектура

Расширение состоит из нескольких модулей:

1. **`data.js`** - управление данными расширений
   - `getPersonaExtensions(avatarId)` - получение списка расширений для персоны
   - `savePersonaExtensions(avatarId, extensions)` - сохранение расширений

2. **`ui.js`** - создание и управление пользовательским интерфейсом
   - `createExtensionField(extensionData, index)` - создание UI элемента блока
   - `renderExtensionsUI()` - отрисовка всех блоков
   - `setupExtensionFieldsEventHandlers()` - настройка обработчиков событий
   - `addExtensionField()` - добавление нового блока
   - `createExtensionsContainer()` - создание основного контейнера

3. **`prompt-injection.js`** - инжекция расширений в промпт
   - `injectPersonaExtensions(userAvatar)` - добавление расширений в промпт перед генерацией

4. **`index.js`** - точка входа, инициализация и координация модулей

### Потоки данных

1. **Сохранение данных:**
   - Данные хранятся в `power_user.persona_descriptions[avatarId].extensions`
   - Каждое расширение имеет структуру: `{title: string, description: string, enabled: boolean}`
   - При изменении данных вызывается `saveSettingsDebounced()` для сохранения настроек

2. **Загрузка данных:**
   - При открытии панели управления персоной загружаются расширения для текущей персоны
   - UI автоматически обновляется при смене персоны

3. **Инжекция в промпт:**
   - Перед генерацией ответа (событие `GENERATE_AFTER_COMBINE_PROMPTS`) вызывается `injectPersonaExtensions()`
   - Включенные расширения форматируются и добавляются в системный промпт через `setExtensionPrompt()`
   - Формат: если есть заголовок и описание - `"Заголовок: Описание"`, иначе только описание или заголовок

## Как использовать

### Добавление блока описания

1. Откройте панель управления персоной (кнопка управления персоной в интерфейсе)
2. Найдите секцию **"Дополнительные описания"**
3. Нажмите кнопку **"+"** для добавления нового блока

### Редактирование блока

1. Нажмите на заголовок блока, чтобы развернуть его (или используйте иконку chevron справа)
2. В развернутом блоке:
   - **Заголовок** - введите название блока (отображается в свернутом виде)
   - **Описание** - введите текст описания, который будет добавлен в промпт
   - **Чекбокс "Включено"** - позволяет временно отключить блок без удаления

### Удаление блока

Нажмите кнопку корзины в заголовке блока для его удаления.

### Включение/выключение блока

Используйте чекбокс "Включено" в заголовке блока. Отключенные блоки не добавляются в промпт при генерации.

## Технические детали

### Хранение данных

Данные расширений хранятся в структуре персоны:
```javascript
power_user.persona_descriptions[avatarId].extensions = [
    {
        title: "Название блока",
        description: "Текст описания",
        enabled: true
    },
    // ... другие блоки
]
```

### Инжекция в промпт

Расширения добавляются в системный промпт через механизм расширений SillyTavern:
- Используется ключ `PERSONA_EXTENSIONS_DATA`
- Тип инжекции: `IN_PROMPT`
- Роль: `SYSTEM`
- Только включенные блоки с непустым заголовком или описанием добавляются в промпт

### Структура UI

Каждый блок использует стандартный механизм `inline-drawer` SillyTavern:
- Заголовок с классом `inline-drawer-toggle inline-drawer-header`
- Контент с классом `inline-drawer-content` (скрыт по умолчанию)
- Иконка переключения `fa-circle-chevron-down` / `fa-circle-chevron-up`
- Автоматическая обработка кликов через глобальный обработчик SillyTavern

### Стандартные классы SillyTavern

Расширение использует стандартные классы SillyTavern для согласованности интерфейса:
- `text_pole` - для полей ввода и textarea
- `menu_button` - для кнопок
- `checkbox_label` - для чекбоксов
- `inline-drawer` - для collapsible секций
- CSS переменные (`--SmartThemeBorderColor`, `--SmartThemeBodyColor` и т.д.) для цветов

## Структура файлов расширения

```
persona-extensions/
├── manifest.json          # Манифест расширения
├── index.js              # Главный файл инициализации
├── data.js               # Управление данными
├── ui.js                  # Пользовательский интерфейс
├── prompt-injection.js    # Инжекция в промпт
├── style.css             # Стили расширения (минимальные)
└── README.md             # Документация (этот файл)
```

## Разработка

### Зависимости

Расширение использует следующие модули SillyTavern:
- `eventSource`, `event_types` из `/script.js`
- `power_user` из `/scripts/power-user.js`
- `user_avatar` из `/scripts/personas.js`
- `saveSettingsDebounced`, `setExtensionPrompt` из `/script.js`

### События

Расширение подписывается на следующие события:
- `EXTENSION_SETTINGS_LOADED` - загрузка настроек
- `APP_READY` - готовность приложения
- `CHAT_CHANGED` - изменение чата/персоны
- `GENERATE_AFTER_COMBINE_PROMPTS` - перед генерацией ответа

## Версия

Текущая версия: 1.0.0

